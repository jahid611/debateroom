<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DebateRoom</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        :root { --bg:#000; --panel:#121212; --accent:#D4AF37; --text:#fff; --border:rgba(255,255,255,0.08); --sidebar-width: 240px; --chat-width: 350px; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Outfit', sans-serif; }
        body { background:var(--bg); color:var(--text); overflow:hidden; height:100vh; width:100vw; display:flex; }

        /* --- LAYOUT PC (3 COLONNES) --- */
        .app-container { display: grid; grid-template-columns: var(--sidebar-width) 1fr var(--chat-width); width: 100%; height: 100%; }

        /* SIDEBAR GAUCHE */
        .sidebar-left { background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; z-index: 10; }
        .logo { font-family:'Oswald'; font-size:1.5rem; color:#fff; text-decoration:none; letter-spacing:-0.5px; display: flex; align-items: center; gap: 5px; }
        .logo span { color:var(--accent); }
        .user-profile { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .user-profile:hover { background: rgba(255,255,255,0.1); }
        .avatar { width:40px; height:40px; border-radius:50%; background:#333; background-size:cover; border:1px solid var(--border); }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 0.9rem; }
        .user-more { font-size: 0.8rem; color: #888; }

        /* FEED CENTRAL */
        .feed-container { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; height: 100vh; position: relative; background: #000; }
        .slide { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; display: flex; justify-content: center; align-items: center; background: #000; }
        .video-wrapper { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
        .video-wrapper video { width: auto; height: 100%; max-width: 100%; object-fit: contain; }
        
        /* OVERLAYS VIDEO (TITRE, VOTES) */
        .video-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%); padding: 20px; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        .video-overlay > * { pointer-events: auto; }
        .info { margin-bottom: 15px; }
        .tag { background:var(--accent); color:#000; padding:4px 8px; border-radius:6px; font-weight:800; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; display:inline-block; margin-bottom:8px; }
        .title { font-weight:700; font-size:1.1rem; line-height:1.3; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        /* VOTES (Style TikTok à droite) */
        .votes-overlay { position: absolute; right: 15px; bottom: 100px; display: flex; flex-direction: column; gap: 15px; align-items: center; z-index: 20; }
        .v-btn { width: 50px; height: 50px; background: rgba(0,0,0,0.4); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; font-size: 1.2rem; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .v-btn:hover { background: rgba(0,0,0,0.6); transform: scale(1.1); }
        .v-btn.valid.active { color: #2ecc71; border-color: #2ecc71; }
        .v-btn.inting.active { color: #e74c3c; border-color: #e74c3c; }
        .v-btn span.c { font-size: 0.7rem; font-weight: 600; margin-top: 2px; }

        /* SIDEBAR DROITE (CHAT) */
        .sidebar-right { background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; z-index: 10; }
        .chat-header { padding: 20px; border-bottom: 1px solid var(--border); font-family: 'Oswald'; font-size: 1.1rem; }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px 20px; display: flex; flex-direction: column; gap: 10px; scrollbar-width: thin; scrollbar-color: #333 transparent; }
        .msg { font-size:0.9rem; line-height:1.4; animation:fadeIn 0.2s ease; word-break: break-word; }
        .msg b { color:var(--accent); margin-right:6px; font-weight:600; font-size:0.85rem; }
        .msg.sys { color:#666; font-style:italic; font-size:0.8rem; text-align:center; margin:10px 0; }

        /* INPUT CHAT */
        .input-box { padding:20px; display:flex; gap:10px; background:var(--panel); border-top:1px solid var(--border); }
        input { flex:1; background:#000; border:1px solid var(--border); padding:14px; border-radius:12px; color:#fff; outline:none; transition:0.3s; }
        input:focus { border-color:var(--accent); }
        .send { width:48px; height:48px; border-radius:50%; background:var(--accent); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#000; transition:0.2s; font-size:1rem; }
        .send:hover { transform:scale(1.1); box-shadow:0 0 15px rgba(212,175,55,0.4); }

        /* --- MOBILE (LAYOUT TIKTOK) --- */
        @media(max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar-left, .sidebar-right { display: none; }
            .video-wrapper video { object-fit: cover; width: 100%; }
            .video-overlay { padding-bottom: 80px; } /* Espace pour la nav du bas */

            /* Navigation du bas (Mobile) */
            .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 100; }
            .nav-item { color: #888; font-size: 1.4rem; cursor: pointer; transition: 0.2s; }
            .nav-item.active { color: #fff; }
            .nav-item.create { background: var(--accent); color: #000; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 0 15px rgba(212,175,55,0.3); }

            /* Boutons Chat & Share (Mobile) */
            .mobile-actions { position: absolute; right: 15px; bottom: 220px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 20; }
            .action-btn { width: 45px; height: 45px; display: flex; flex-direction: column; align-items: center; color: #fff; font-size: 1.6rem; cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
            .action-btn span { font-size: 0.7rem; font-weight: 600; margin-top: 5px; }

            /* Modal Chat (Mobile) */
            .chat-modal { position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh; background: var(--panel); border-radius: 20px 20px 0 0; z-index: 200; transform: translateY(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
            .chat-modal.show { transform: translateY(0); }
            .chat-modal .chat-header { display: flex; justify-content: space-between; align-items: center; }
            .close-chat { background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; }
        }

        /* MODAL CREATION (Commun) */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:300; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal.show { display:flex; }
        .modal-box { background:#1a1a1a; padding:30px; border-radius:20px; width:90%; max-width:400px; display:flex; flex-direction:column; gap:15px; border:1px solid var(--border); animation:popIn 0.3s ease; }
        .modal h3 { font-family:'Oswald'; font-size:1.5rem; color:#fff; margin:0 0 10px; }
        select, input.modal-in { width:100%; padding:14px; background:#000; border:1px solid var(--border); color:#fff; border-radius:10px; outline:none; }
        .btn-pub { width:100%; padding:14px; background:var(--accent); border:none; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; letter-spacing:1px; }
        @keyframes popIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="sidebar-left">
            <a href="#" class="logo"><i class="fa-solid fa-gavel"></i> DEBATE<span>ROOM</span></a>
            <div class="user-profile" onclick="toggleMenu()">
                <div class="avatar" id="headAvatar"></div>
                <div class="user-info">
                    <span class="user-name" id="headName">...</span>
                    <span class="user-more">Voir le profil</span>
                </div>
            </div>
            <div class="dropdown" id="menu" style="display:none; position:absolute; top:80px; left:20px; width:200px; background:#1a1a1a; border:1px solid var(--border); border-radius:12px; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.8);">
                <div class="item" onclick="location.href='onboarding.html'" style="padding:14px; cursor:pointer; color:#ccc; display:flex; align-items:center; gap:12px; font-size:0.9rem;"><i class="fa-solid fa-user-pen"></i> Profil</div>
                <div class="item red" onclick="logout()" style="padding:14px; cursor:pointer; color:#ff4d4d; display:flex; align-items:center; gap:12px; font-size:0.9rem; border-top:1px solid var(--border);"><i class="fa-solid fa-power-off"></i> Déconnexion</div>
            </div>
            <button onclick="openModal()" style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; letter-spacing:1px; display:flex; align-items:center; justify-content:center; gap:10px;"><i class="fa-solid fa-plus"></i> Créer</button>
        </div>

        <div class="feed-container" id="feedContainer"></div>

        <div class="sidebar-right" id="deskChatPanel">
            <div class="chat-header">Chat du débat</div>
            <div class="chat-list" id="deskChatList"><div class="msg sys">Sélectionnez un débat</div></div>
            <div class="input-box">
                <input type="text" id="deskChatInput" placeholder="Ton avis ?">
                <button class="send" onclick="sendDeskMsg()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="mobile-nav">
            <i class="fa-solid fa-house nav-item active"></i>
            <i class="fa-solid fa-user-group nav-item"></i>
            <div class="nav-item create" onclick="openModal()"><i class="fa-solid fa-plus"></i></div>
            <i class="fa-solid fa-inbox nav-item"></i>
            <i class="fa-solid fa-user nav-item" onclick="location.href='onboarding.html'"></i>
        </div>

        <div class="chat-modal" id="mobChatModal">
            <div class="chat-header">
                <span>Commentaires</span>
                <button class="close-chat" onclick="closeMobChat()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="chat-list" id="mobChatList"></div>
            <div class="input-box" style="background: var(--panel);">
                <input type="text" id="mobChatInput" placeholder="Ajouter un commentaire...">
                <button class="send" onclick="sendMobMsg()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

    </div>

    <div class="modal" id="addModal">
        <div class="modal-box">
            <h3>Nouveau Débat</h3>
            <select id="newGame" class="modal-input" style="margin-bottom:15px;">
                <option value="lol">League of Legends</option>
                <option value="valorant">Valorant</option>
                <option value="rl">Rocket League</option>
            </select>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button id="tabLink" onclick="switchTab('link')" style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #444; border-radius:8px; cursor:pointer; font-weight:600;">Lien</button>
                <button id="tabFile" onclick="switchTab('file')" style="flex:1; padding:10px; background:transparent; color:#888; border:1px solid #444; border-radius:8px; cursor:pointer; font-weight:600;">Fichier</button>
            </div>
            <div id="inputLinkGroup">
                <input type="text" id="newLink" class="modal-in" placeholder="Coller un lien (TikTok, YouTube...)">
            </div>
            <div id="inputFileGroup" style="display:none;">
                <label style="display:block; padding:30px; border:2px dashed #444; border-radius:10px; text-align:center; cursor:pointer; color:#888; transition:0.2s;">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem; margin-bottom:10px; color:var(--accent);"></i><br>
                    <span id="fileName" style="font-size:0.9rem;">Clique pour choisir une vidéo</span>
                    <input type="file" id="videoFile" accept="video/*" style="display:none;" onchange="updateFileName()">
                </label>
            </div>
            <button class="btn-pub" onclick="createRoom()" style="margin-top:15px;">PUBLIER</button>
            <button onclick="closeModal()" style="background:transparent; border:none; color:#888; cursor:pointer; margin-top:10px; width:100%;">Annuler</button>
        </div>
    </div>

    <script>
        const rawUser = localStorage.getItem('user_profile');
        if(!rawUser) window.location.href = 'login.html';
        const user = JSON.parse(rawUser);
        document.getElementById('headName').innerText = user.given_name;
        document.getElementById('headAvatar').style.backgroundImage = `url('${user.picture || "https://cdn-icons-png.flaticon.com/512/847/847969.png"}')`;

        const socket = io("https://debateroom-u1gz.onrender.com");
        let currentRoomId = null; // Pour savoir sur quelle room on est

        function getPlayerHTML(room) {
            if (room.videoUrl.includes('youtube.com/embed')) {
                return `<iframe src="${room.videoUrl}" style="width:100%; height:100%; border:none; pointer-events:none;" allow="autoplay; encrypted-media"></iframe>`;
            } else if (room.videoUrl.includes('tiktok.com/embed')) {
                return `<div style="width:100%; height:100%; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#000;"><iframe src="${room.videoUrl}" style="width:100%; height:120%; border:none; transform: scale(1.1);" allow="autoplay; encrypted-media"></iframe></div>`;
            } else {
                return `<video src="${room.videoUrl}" loop playsinline muted autoplay></video>`;
            }
        }

        async function loadFeed() {
            try {
                const res = await fetch('https://debateroom-u1gz.onrender.com/api/feed/foryou?email='+user.email);
                const rooms = await res.json();
                const container = document.getElementById('feedContainer');
                container.innerHTML = '';
                if(rooms.length === 0) container.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;color:#666;">Aucun débat. Lancez-en un !</div>';

                rooms.forEach(room => {
                    const v = room.votes?.valid?.length || 0;
                    const i = room.votes?.inting?.length || 0;
                    const player = getPlayerHTML(room);

                    const slide = document.createElement('div');
                    slide.className = 'slide';
                    slide.dataset.slug = room.slug;
                    slide.innerHTML = `
                        <div class="video-wrapper">${player}</div>
                        <div class="video-overlay">
                            <div class="info"><span class="tag">${room.game}</span><div class="title">${room.videoTitle}</div></div>
                        </div>
                        <div class="mobile-actions">
                            <div class="action-btn" onclick="openMobChat('${room.slug}')"><i class="fa-solid fa-comment-dots"></i><span>Chat</span></div>
                            <div class="action-btn"><i class="fa-solid fa-share"></i><span>Partager</span></div>
                        </div>
                        <div class="votes-overlay" id="votes-${room.slug}">
                            <div class="v-btn valid" onclick="doVote('${room.slug}','valid')"><i class="fa-solid fa-check"></i><span class="c">${v}</span></div>
                            <div class="v-btn inting" onclick="doVote('${room.slug}','inting')"><i class="fa-solid fa-xmark"></i><span class="c">${i}</span></div>
                        </div>
                    `;
                    container.appendChild(slide);
                });
                initObserver();
            } catch(e) { console.error(e); }
        }

        function initObserver() {
            const obs = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    const roomId = e.target.dataset.slug;
                    const video = e.target.querySelector('video');
                    const iframe = e.target.querySelector('iframe');
                    if(e.isIntersecting) {
                        currentRoomId = roomId; // On note la room active
                        socket.emit('join_room', roomId);
                        if(video) video.play();
                        updateDeskChat(roomId); // Met à jour le chat PC
                    } else {
                        if(video) { video.pause(); video.currentTime = 0; }
                        if(iframe) { const src = iframe.src; iframe.src = src; }
                    }
                });
            }, {threshold:0.5});
            document.querySelectorAll('.slide').forEach(s => obs.observe(s));
        }

        // --- LOGIQUE CHAT UNIFIÉE ---
        let currentChatMessages = []; // Stocke les messages de la room active

        function updateDeskChat(roomId) {
            const list = document.getElementById('deskChatList');
            list.innerHTML = '<div class="msg sys">Chargement...</div>';
            list.dataset.room = roomId;
            // Le contenu sera rempli par socket.on('init_room')
        }

        function openMobChat(roomId) {
            currentRoomId = roomId;
            document.getElementById('mobChatModal').classList.add('show');
            const list = document.getElementById('mobChatList');
            list.innerHTML = ''; // On vide avant de remplir
            // On remplit avec les messages déjà chargés
            currentChatMessages.forEach(msg => addMessageToUI(list, msg, msg.isRoomOwner));
            list.scrollTop = list.scrollHeight;
        }
        window.closeMobChat = () => document.getElementById('mobChatModal').classList.remove('show');

        socket.on('init_room', (data) => {
            if(data.roomId === currentRoomId) {
                currentChatMessages = data.messages || [];
                const isRoomOwner = data.ownerEmail === user.email;
                
                // Update PC Chat
                const deskList = document.getElementById('deskChatList');
                if(deskList.dataset.room === data.roomId) {
                    deskList.innerHTML = '<div class="msg sys">Débat commencé</div>';
                    currentChatMessages.forEach(msg => addMessageToUI(deskList, msg, isRoomOwner));
                    deskList.scrollTop = deskList.scrollHeight;
                }

                // Update Votes
                const vb = document.getElementById(`votes-${data.roomId}`);
                if(vb) {
                    vb.querySelector('.valid .c').innerText = data.votes.valid;
                    vb.querySelector('.inting .c').innerText = data.votes.inting;
                }
            }
        });

        socket.on('receive_message', (msg) => {
            if(msg.roomId === currentRoomId) {
                currentChatMessages.push(msg);
                // Update PC
                const deskList = document.getElementById('deskChatList');
                if(deskList.dataset.room === msg.roomId) { addMessageToUI(deskList, msg, false); deskList.scrollTop = deskList.scrollHeight; }
                // Update Mobile if open
                const mobList = document.getElementById('mobChatList');
                if(document.getElementById('mobChatModal').classList.contains('show')) { addMessageToUI(mobList, msg, false); mobList.scrollTop = mobList.scrollHeight; }
            }
        });

        function addMessageToUI(container, msg, isRoomOwner) {
            const div = document.createElement('div');
            div.className = 'msg'; div.id = `msg-${msg._id}`;
            const canDelete = (msg.userEmail === user.email) || isRoomOwner;
            const deleteBtn = canDelete ? `<i class="fa-solid fa-trash" style="color:#666; cursor:pointer; margin-left:10px; font-size:0.8rem;" onclick="deleteMsg('${msg._id}', '${msg.roomId}')"></i>` : '';
            div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:start;"><span><b>${msg.username}:</b> ${msg.text}</span>${deleteBtn}</div>`;
            container.appendChild(div);
        }

        // Envoi de message (PC & Mobile)
        window.sendDeskMsg = () => sendUnifiedMsg('deskChatInput');
        window.sendMobMsg = () => sendUnifiedMsg('mobChatInput');

        function sendUnifiedMsg(inputId) {
            const input = document.getElementById(inputId);
            if(input.value && currentRoomId) {
                socket.emit('send_message', { roomId: currentRoomId, username: user.given_name, userEmail: user.email, text: input.value });
                input.value = '';
            }
        }
        
        document.getElementById('deskChatInput').addEventListener('keypress', (e) => { if(e.key==='Enter') sendDeskMsg(); });
        document.getElementById('mobChatInput').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMobMsg(); });


        // --- ACTIONS COMMUNES ---
        window.doVote = (rid, c) => {
            const box = document.getElementById(`votes-${rid}`);
            box.querySelectorAll('.v-btn').forEach(b => b.classList.remove('active'));
            box.querySelector(`.${c}`).classList.add('active');
            socket.emit('send_vote', { roomId:rid, choice:c, userId:user.email });
        };
        socket.on('update_votes', d => {
            const b = document.getElementById(`votes-${d.roomId}`);
            if(b) { b.querySelector('.valid .c').innerText=d.valid; b.querySelector('.inting .c').innerText=d.inting; }
        });
        window.deleteMsg = (msgId, roomId) => { if(confirm("Supprimer ?")) socket.emit('delete_message', { messageId: msgId, roomId: roomId, userEmail: user.email }); };
        socket.on('message_deleted', (msgId) => { const el = document.getElementById(`msg-${msgId}`); if(el) el.remove(); });

        // --- CREATION & UI ---
        let uploadMode='link';
        window.switchTab=(m)=>{uploadMode=m;document.getElementById('inputLinkGroup').style.display=m==='link'?'block':'none';document.getElementById('inputFileGroup').style.display=m==='file'?'block':'none';document.getElementById('tabLink').style.background=m==='link'?'#333':'transparent';document.getElementById('tabFile').style.background=m==='file'?'#333':'transparent';};
        window.updateFileName=()=>{const f=document.getElementById('videoFile').files[0];if(f)document.getElementById('fileName').innerText=f.name;};
        window.createRoom=async()=>{
            const game=document.getElementById('newGame').value;const btn=document.querySelector('.btn-pub');btn.innerText="Traitement...";btn.disabled=true;
            try{let finalSrc="";if(uploadMode==='link'){const url=document.getElementById('newLink').value;if(!url)throw new Error("Lien requis");const res=await fetch(`https://debateroom-u1gz.onrender.com/api/video/resolve?url=${encodeURIComponent(url)}`);const data=await res.json();if(data.error)throw new Error(data.error);finalSrc=data.src;}else{const f=document.getElementById('videoFile').files[0];if(!f)throw new Error("Fichier requis");const fd=new FormData();fd.append('videoFile',f);const res=await fetch('https://debateroom-u1gz.onrender.com/api/video/upload',{method:'POST',body:fd});const data=await res.json();if(data.error)throw new Error(data.error);finalSrc=data.src;}socket.emit('create_room',{src:finalSrc,title:uploadMode==='link'?"Lien":"Upload",game:game,platform:"Web",userEmail:user.email});closeModal();}catch(e){alert(e.message);btn.innerText="PUBLIER";btn.disabled=false;}
        };
        socket.on('room_created',()=>window.location.reload());
        window.toggleMenu=()=>document.getElementById('menu').style.display=document.getElementById('menu').style.display==='flex'?'none':'flex';
        window.logout=()=>{localStorage.clear();window.location.href='login.html';};
        window.openModal=()=>document.getElementById('addModal').classList.add('show');
        window.closeModal=()=>document.getElementById('addModal').classList.remove('show');

        loadFeed();
    </script>
</body>
</html>