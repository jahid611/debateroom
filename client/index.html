<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DebateRoom</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        :root { --bg:#000; --panel:#121212; --accent:#D4AF37; --text:#fff; --border:rgba(255,255,255,0.08); --chat-width: 400px; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Outfit', sans-serif; }
        body { background:var(--bg); color:var(--text); overflow:hidden; height:100vh; width:100vw; display:flex; flex-direction:column; }

        /* LAYOUT PRINCIPAL */
        .app-container { display: grid; grid-template-columns: 1fr var(--chat-width); width: 100%; height: 100%; padding-top: 60px; transition: 0.3s ease; }
        .app-container.chat-hidden { grid-template-columns: 1fr 0px; }

        /* HEADER */
        header { height:60px; padding:0 20px; display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.9); z-index:100; border-bottom:1px solid var(--border); position:fixed; top:0; width:100%; backdrop-filter:blur(10px); }
        .logo { font-family:'Oswald'; font-size:1.5rem; color:#fff; text-decoration:none; letter-spacing:-0.5px; }
        .logo span { color:var(--accent); }
        .header-actions { display:flex; gap:15px; align-items:center; }
        .icon-btn { background:rgba(255,255,255,0.1); border:none; color:#fff; width:40px; height:40px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .icon-btn:hover { background:var(--accent); color:#000; }
        
        .user-pill { display:flex; align-items:center; gap:10px; cursor:pointer; padding:4px; padding-right:12px; border-radius:30px; transition:0.2s; }
        .user-pill:hover { background:rgba(255,255,255,0.1); }
        .avatar { width:32px; height:32px; border-radius:50%; background:#333; background-size:cover; border:1px solid var(--border); }

        /* MENU */
        .dropdown { position:absolute; top:65px; right:20px; background:#1a1a1a; border:1px solid var(--border); border-radius:12px; width:200px; display:none; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.8); z-index:200; }
        .dropdown.show { display:flex; }
        .item { padding:14px; cursor:pointer; color:#ccc; display:flex; align-items:center; gap:12px; font-size:0.9rem; }
        .item:hover { background:rgba(255,255,255,0.05); color:#fff; }
        .item.red { color:#ff4d4d; border-top:1px solid var(--border); }

        /* FEED VIDEO (CORRECTION STRICTE ICI) */
        .feed-container { overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; height: 100%; background: #000; }
        .slide { height: 100%; width: 100%; scroll-snap-align: start; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; /* Empêche l'étirement */ }
        
        /* CONTENEUR VIDEO STRICT */
        .video-wrapper { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #000;
            overflow: hidden; /* Coupe tout ce qui dépasse */
        }
        
        /* FORCE LE REMPLISSAGE (CROP COMME TIKTOK) */
        .video-wrapper video, .video-wrapper iframe { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; /* C'est la clé ! Remplit l'écran, coupe les bords si besoin */
            display: block;
        }

        /* OVERLAYS */
        .video-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 40px; pointer-events: none; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .info { margin-bottom: 10px; pointer-events: auto; }
        .tag { background:var(--accent); color:#000; padding:4px 8px; border-radius:4px; font-weight:800; font-size:0.8rem; text-transform:uppercase; margin-bottom:8px; display:inline-block; }
        .title { font-weight:700; font-size:1.4rem; text-shadow:0 2px 5px rgba(0,0,0,0.8); width: 80%; }

        /* VOTES */
        .votes-overlay { position: absolute; right: 30px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 20; pointer-events: auto; }
        .v-btn { width: 55px; height: 55px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; font-size: 1.3rem; cursor: pointer; transition: 0.2s; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .v-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .v-btn.valid.active { background: #2ecc71; color:#000; border-color:#2ecc71; }
        .v-btn.inting.active { background: #e74c3c; color:#000; border-color:#e74c3c; }
        .v-btn span.c { font-size: 0.7rem; font-weight: 700; margin-top: -2px; }

        /* CHAT SIDEBAR */
        .sidebar-right { background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; }
        .chat-header { padding: 15px; border-bottom: 1px solid var(--border); font-family: 'Oswald'; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        .share-btn-pc { background: transparent; border: 1px solid var(--border); color: #ccc; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; display: flex; gap: 6px; align-items: center; }
        .share-btn-pc:hover { border-color: var(--accent); color: var(--accent); }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        /* STYLE MESSAGES AVEC AVATAR */
        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .msg-avatar { width: 24px; height: 24px; border-radius: 50%; background-size: cover; border: 1px solid var(--border); flex-shrink: 0; }
        .user-badges { position: relative; display: inline-block; margin-left: 5px; cursor: help; }
        .main-badge { font-size: 0.65rem; background: rgba(255,255,255,0.1); border: 1px solid var(--border); padding: 2px 6px; border-radius: 4px; color: #aaa; transition: 0.2s; white-space: nowrap; }
        .user-badges:hover .main-badge { color: var(--accent); border-color: var(--accent); background: rgba(212,175,55,0.1); }
        .badges-popup { display: none; position: absolute; bottom: 20px; left: 0; background: #222; border: 1px solid var(--accent); border-radius: 8px; padding: 8px; z-index: 100; min-width: 120px; }
        .user-badges:hover .badges-popup { display: block; }
        .popup-row { font-size: 0.7rem; color: #ccc; margin-bottom: 4px; display: flex; justify-content: space-between; gap: 10px; }
        .popup-row span.r { color: var(--accent); font-weight: bold; }

        .input-box { padding:20px; display:flex; gap:10px; background:var(--panel); border-top:1px solid var(--border); }
        input { flex:1; background:#000; border:1px solid var(--border); padding:14px; border-radius:12px; color:#fff; outline:none; }
        .send { width:48px; height:48px; border-radius:50%; background:var(--accent); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#000; }

        /* MOBILE */
        @media(max-width: 900px) {
            .app-container { grid-template-columns: 1fr; padding-top: 0; }
            header { display: none; }
            .sidebar-right { display: none; }
            .video-overlay { padding: 20px; padding-bottom: 80px; }
            .votes-overlay { bottom: 100px; right: 15px; }
            .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 100; }
            .nav-item { color: #888; font-size: 1.4rem; cursor: pointer; }
            .nav-item.active { color: #fff; }
            .nav-item.create { background: var(--accent); color: #000; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
            .mobile-actions { position: absolute; right: 15px; bottom: 230px; display: flex; flex-direction: column; gap: 20px; z-index: 20; }
            .action-btn { width: 45px; display: flex; flex-direction: column; align-items: center; color: #fff; font-size: 1.6rem; cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
            .chat-modal { position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh; background: var(--panel); border-radius: 20px 20px 0 0; z-index: 200; transform: translateY(100%); transition: 0.3s; display: flex; flex-direction: column; }
            .chat-modal.show { transform: translateY(0); }
        }

        /* MODAL */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:300; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal.show { display:flex; }
        .modal-box { background:#1a1a1a; padding:30px; border-radius:20px; width:90%; max-width:400px; display:flex; flex-direction:column; gap:15px; border:1px solid var(--border); }
        .btn-pub { width:100%; padding:14px; background:var(--accent); border:none; border-radius:10px; font-weight:bold; cursor:pointer; }
    </style>
</head>
<body>

    <header>
        <a href="#" class="logo">DEBATE<span>ROOM</span></a>
        <div class="header-actions">
            <button class="icon-btn" onclick="openModal()"><i class="fa-solid fa-plus"></i></button>
            <button class="icon-btn" onclick="toggleDeskChat()"><i class="fa-solid fa-message"></i></button>
            <div style="position:relative;">
                <div class="user-pill" onclick="toggleMenu()">
                    <div class="avatar" id="headAvatar"></div>
                    <span id="headName" style="font-weight:500; font-size:0.9rem;">...</span>
                    <i class="fa-solid fa-chevron-down" style="font-size:0.7rem; color:#666;"></i>
                </div>
                <div class="dropdown" id="menu">
                    <div class="item" onclick="location.href='editprofile.html'"><i class="fa-solid fa-user-pen"></i> Profil</div>
                    <div class="item red" onclick="logout()"><i class="fa-solid fa-power-off"></i> Déconnexion</div>
                </div>
            </div>
        </div>
    </header>

    <div class="app-container" id="appContainer">
        <div class="feed-container" id="feedContainer"></div>
        <div class="sidebar-right" id="deskChatPanel">
            <div class="chat-header">
                <span>Chat</span>
                <button class="share-btn-pc" onclick="shareCurrentRoom()"><i class="fa-solid fa-share-nodes"></i> Partager</button>
            </div>
            <div class="chat-list" id="deskChatList"><div class="msg sys">Sélectionnez un débat</div></div>
            <div class="input-box">
                <input type="text" id="deskChatInput" placeholder="Ton avis ?">
                <button class="send" onclick="sendDeskMsg()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <i class="fa-solid fa-house nav-item active"></i>
        <i class="fa-solid fa-compass nav-item"></i>
        <div class="nav-item create" onclick="openModal()"><i class="fa-solid fa-plus"></i></div>
        <i class="fa-solid fa-inbox nav-item"></i>
        <i class="fa-solid fa-user nav-item" onclick="location.href='editprofile.html'"></i>
    </div>

    <div class="chat-modal" id="mobChatModal">
        <div class="chat-header" style="padding:15px; display:flex; justify-content:space-between;">
            <b>Commentaires</b>
            <button class="close-chat" onclick="closeMobChat()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="chat-list" id="mobChatList"></div>
        <div class="input-box" style="background:var(--panel);">
            <input type="text" id="mobChatInput" placeholder="Ajouter un commentaire...">
            <button class="send" onclick="sendMobMsg()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-box">
            <h3 style="font-family:'Oswald'; color:#fff; margin-bottom:10px;">Nouveau Débat</h3>
            <select id="newGame" style="width:100%; padding:12px; background:#000; border:1px solid #444; color:#fff; border-radius:10px;">
                <option value="lol">League of Legends</option>
                <option value="valorant">Valorant</option>
                <option value="rl">Rocket League</option>
            </select>
            <div style="display:flex; gap:10px; margin:15px 0;">
                <button id="tabLink" onclick="switchTab('link')" style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #444; border-radius:8px; cursor:pointer;">Lien</button>
                <button id="tabFile" onclick="switchTab('file')" style="flex:1; padding:10px; background:transparent; color:#888; border:1px solid #444; border-radius:8px; cursor:pointer;">Fichier</button>
            </div>
            <div id="inputLinkGroup"><input type="text" id="newLink" placeholder="Coller un lien..." style="width:100%; padding:12px; background:#000; border:1px solid #444; color:#fff; border-radius:10px;"></div>
            <div id="inputFileGroup" style="display:none;">
                <label style="display:block; padding:30px; border:2px dashed #444; border-radius:10px; text-align:center; cursor:pointer; color:#888;">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem; margin-bottom:10px; color:var(--accent);"></i><br><span id="fileName">Choisir vidéo</span>
                    <input type="file" id="videoFile" accept="video/*" style="display:none;" onchange="updateFileName()">
                </label>
            </div>
            <button class="btn-pub" onclick="createRoom()" style="margin-top:15px;">PUBLIER</button>
            <button onclick="closeModal()" style="background:transparent; border:none; color:#888; cursor:pointer; margin-top:10px; width:100%;">Annuler</button>
        </div>
    </div>

    <script>
        const rawUser = localStorage.getItem('user_profile');
        if(!rawUser) window.location.href = 'login.html';
        const user = JSON.parse(rawUser);
        document.getElementById('headName').innerText = user.given_name;
        document.getElementById('headAvatar').style.backgroundImage = `url('${user.picture || "https://cdn-icons-png.flaticon.com/512/847/847969.png"}')`;

        const socket = io("https://debateroom-u1gz.onrender.com");
        let currentRoomId = null;
        const urlParams = new URLSearchParams(window.location.search);
        const startRoom = urlParams.get('room');

        window.shareCurrentRoom = () => { if(currentRoomId) shareRoom(currentRoomId); };
        window.shareRoom = (slug) => {
            const url = `${window.location.origin}${window.location.pathname}?room=${slug}`;
            navigator.clipboard.writeText(url).then(() => alert("Lien copié !"));
        };

        function getPlayerHTML(room) {
            if (room.videoUrl.includes('youtube.com/embed')) return `<iframe src="${room.videoUrl}" allow="autoplay; encrypted-media"></iframe>`;
            if (room.videoUrl.includes('tiktok.com/embed')) return `<iframe src="${room.videoUrl}" style="transform:scale(1.1);"></iframe>`;
            return `<video src="${room.videoUrl}" loop playsinline muted autoplay></video>`;
        }

        async function loadFeed() {
            try {
                const res = await fetch('https://debateroom-u1gz.onrender.com/api/feed/foryou?email='+user.email);
                const rooms = await res.json();
                const container = document.getElementById('feedContainer');
                container.innerHTML = '';

                rooms.forEach(room => {
                    const v = room.votes?.valid?.length || 0;
                    const i = room.votes?.inting?.length || 0;
                    const slide = document.createElement('div');
                    slide.className = 'slide';
                    slide.dataset.slug = room.slug;
                    slide.id = `room-${room.slug}`;
                    
                    slide.innerHTML = `
                        <div class="video-wrapper">${getPlayerHTML(room)}</div>
                        <div class="video-overlay"><div class="info"><span class="tag">${room.game}</span><div class="title">${room.videoTitle}</div></div></div>
                        <div class="mobile-actions">
                            <div class="action-btn" onclick="openMobChat('${room.slug}')"><i class="fa-solid fa-comment-dots"></i><span>Chat</span></div>
                            <div class="action-btn" onclick="shareRoom('${room.slug}')"><i class="fa-solid fa-share"></i><span>Partager</span></div>
                        </div>
                        <div class="votes-overlay" id="votes-${room.slug}">
                            <div class="v-btn valid" onclick="doVote('${room.slug}','valid')"><i class="fa-solid fa-check"></i><span class="c">${v}</span></div>
                            <div class="v-btn inting" onclick="doVote('${room.slug}','inting')"><i class="fa-solid fa-xmark"></i><span class="c">${i}</span></div>
                        </div>
                    `;
                    container.appendChild(slide);
                });
                initObserver();
                if(startRoom) setTimeout(() => document.getElementById(`room-${startRoom}`)?.scrollIntoView(), 500);
            } catch(e) { console.error(e); }
        }

        function initObserver() {
            const obs = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    const roomId = e.target.dataset.slug;
                    const video = e.target.querySelector('video');
                    if(e.isIntersecting) {
                        currentRoomId = roomId;
                        socket.emit('join_room', roomId);
                        if(video) video.play();
                        updateDeskChat(roomId);
                    } else {
                        if(video) { video.pause(); video.currentTime=0; }
                    }
                });
            }, {threshold:0.5});
            document.querySelectorAll('.slide').forEach(s => obs.observe(s));
        }

        // CHAT
        let currentChatMessages = [];
        function updateDeskChat(roomId) {
            const list = document.getElementById('deskChatList');
            list.innerHTML = '<div class="msg sys">Chargement...</div>';
            list.dataset.room = roomId;
        }
        function openMobChat(roomId) {
            currentRoomId = roomId;
            document.getElementById('mobChatModal').classList.add('show');
            const list = document.getElementById('mobChatList');
            list.innerHTML = '';
            currentChatMessages.forEach(msg => addMessageToUI(list, msg, msg.isRoomOwner));
            list.scrollTop = list.scrollHeight;
        }
        window.closeMobChat = () => document.getElementById('mobChatModal').classList.remove('show');
        window.toggleDeskChat = () => document.getElementById('appContainer').classList.toggle('chat-hidden');

        socket.on('init_room', (data) => {
            if(data.roomId === currentRoomId) {
                currentChatMessages = data.messages || [];
                const isOwner = data.ownerEmail === user.email;
                const dList = document.getElementById('deskChatList');
                if(dList.dataset.room === data.roomId) {
                    dList.innerHTML = '<div class="msg sys">Débat commencé</div>';
                    currentChatMessages.forEach(m => addMessageToUI(dList, m, isOwner));
                    dList.scrollTop = dList.scrollHeight;
                }
                const b = document.getElementById(`votes-${data.roomId}`);
                if(b) { b.querySelector('.valid .c').innerText=data.votes.valid; b.querySelector('.inting .c').innerText=data.votes.inting; }
            }
        });

        socket.on('receive_message', (msg) => {
            if(msg.roomId === currentRoomId) {
                currentChatMessages.push(msg);
                const dList = document.getElementById('deskChatList');
                if(dList.dataset.room === msg.roomId) { addMessageToUI(dList, msg, false); dList.scrollTop = dList.scrollHeight; }
                const mList = document.getElementById('mobChatList');
                if(document.getElementById('mobChatModal').classList.contains('show')) { addMessageToUI(mList, msg, false); mList.scrollTop = mList.scrollHeight; }
            }
        });

        function addMessageToUI(container, msg, isOwner) {
            const div = document.createElement('div');
            div.className = 'msg'; div.id = `msg-${msg._id}`;
            const canDel = (msg.userEmail === user.email) || isOwner;
            const delBtn = canDel ? `<i class="fa-solid fa-trash" style="color:#666; cursor:pointer; margin-left:auto; font-size:0.8rem;" onclick="deleteMsg('${msg._id}','${msg.roomId}')"></i>` : '';
            
            // LOGIQUE BADGES (Réintégrée)
            let badgesHTML = '';
            if (msg.games && msg.games.length > 0 && msg.details) {
                const mainGame = msg.games[0];
                const mainRank = msg.details[mainGame]?.rank || 'Unranked';
                let popupContent = '';
                msg.games.forEach(g => {
                    const r = msg.details[g]?.rank || '-';
                    const names = { 'lol': 'LoL', 'valorant': 'Valo', 'fortnite': 'Fort', 'rl': 'RL' };
                    popupContent += `<div class="popup-row"><span>${names[g] || g}</span> <span class="r">${r}</span></div>`;
                });
                badgesHTML = `<div class="user-badges"><div class="main-badge">${mainGame} • ${mainRank} ${msg.games.length > 1 ? '+' : ''}</div><div class="badges-popup">${popupContent}</div></div>`;
            }

            div.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <div class="msg-header">
                        <div class="msg-avatar" style="background-image:url('${msg.avatar || "https://cdn-icons-png.flaticon.com/512/847/847969.png"}')"></div>
                        <b style="color:var(--accent); font-size:0.85rem;">${msg.username}</b>
                        ${badgesHTML}
                        ${delBtn}
                    </div>
                    <div style="padding-left:32px; font-size:0.95rem; color:#ddd;">${msg.text}</div>
                </div>
            `;
            container.appendChild(div);
        }

        window.deleteMsg = (mid, rid) => { if(confirm("Supprimer ?")) socket.emit('delete_message', { messageId:mid, roomId:rid, userEmail:user.email }); };
        socket.on('message_deleted', (mid) => { const el = document.getElementById(`msg-${mid}`); if(el) el.remove(); });

        window.sendDeskMsg = () => sendUnifiedMsg('deskChatInput');
        window.sendMobMsg = () => sendUnifiedMsg('mobChatInput');
        function sendUnifiedMsg(id) {
            const inp = document.getElementById(id);
            if(inp.value && currentRoomId) {
                socket.emit('send_message', { roomId:currentRoomId, username:user.given_name, userEmail:user.email, text:inp.value });
                inp.value = '';
            }
        }
        document.getElementById('deskChatInput').addEventListener('keypress', e => { if(e.key==='Enter') sendDeskMsg(); });
        document.getElementById('mobChatInput').addEventListener('keypress', e => { if(e.key==='Enter') sendMobMsg(); });

        window.doVote = (rid, c) => {
            const b = document.getElementById(`votes-${rid}`);
            b.querySelectorAll('.v-btn').forEach(x => x.classList.remove('active'));
            b.querySelector('.'+c).classList.add('active');
            socket.emit('send_vote', { roomId:rid, choice:c, userId:user.email });
        };
        socket.on('update_votes', d => {
            const b = document.getElementById(`votes-${d.roomId}`);
            if(b) { b.querySelector('.valid .c').innerText=d.valid; b.querySelector('.inting .c').innerText=d.inting; }
        });

        // CREATE
        let uploadMode='link';
        window.switchTab = (m) => { uploadMode=m; document.getElementById('inputLinkGroup').style.display=m==='link'?'block':'none'; document.getElementById('inputFileGroup').style.display=m==='file'?'block':'none'; document.getElementById('tabLink').style.background=m==='link'?'#333':'transparent'; document.getElementById('tabFile').style.background=m==='file'?'#333':'transparent'; };
        window.updateFileName = () => { const f=document.getElementById('videoFile').files[0]; if(f) document.getElementById('fileName').innerText=f.name; };
        
        window.createRoom = async () => {
            const game = document.getElementById('newGame').value;
            const btn = document.querySelector('.btn-pub');
            btn.innerText = "Traitement..."; btn.disabled = true;
            try {
                let finalSrc = "";
                if(uploadMode==='link') {
                    const url = document.getElementById('newLink').value;
                    const res = await fetch(`https://debateroom-u1gz.onrender.com/api/video/resolve?url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    finalSrc = data.src;
                } else {
                    const f = document.getElementById('videoFile').files[0];
                    const fd = new FormData(); fd.append('videoFile', f);
                    const res = await fetch('https://debateroom-u1gz.onrender.com/api/video/upload', {method:'POST', body:fd});
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    finalSrc = data.src;
                }
                socket.emit('create_room', { src:finalSrc, title:uploadMode==='link'?"Lien":"Upload", game, platform:"Web", userEmail:user.email });
                closeModal();
            } catch(e) { alert(e.message); btn.innerText="PUBLIER"; btn.disabled=false; }
        };
        socket.on('room_created', () => window.location.reload());

        window.toggleMenu = () => document.getElementById('menu').classList.toggle('show');
        window.logout = () => { localStorage.clear(); window.location.href='login.html'; };
        window.openModal = () => document.getElementById('addModal').classList.add('show');
        window.closeModal = () => document.getElementById('addModal').classList.remove('show');

        loadFeed();
    </script>
</body>
</html>