<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DebateRoom</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        :root { --bg:#000; --panel:#121212; --accent:#D4AF37; --text:#fff; --border:rgba(255,255,255,0.08); }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Outfit', sans-serif; }
        body { background:var(--bg); color:var(--text); overflow:hidden; height:100vh; width:100vw; display:flex; flex-direction:column; }

        /* HEADER */
        header { height:60px; padding:0 20px; display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.9); z-index:100; border-bottom:1px solid var(--border); position:fixed; top:0; width:100%; backdrop-filter:blur(10px); }
        .logo { font-family:'Oswald'; font-size:1.4rem; color:#fff; text-decoration:none; letter-spacing:-0.5px; }
        .logo span { color:var(--accent); }
        
        .user-pill { display:flex; align-items:center; gap:10px; cursor:pointer; padding:4px; padding-right:12px; border-radius:30px; border:1px solid transparent; transition:0.2s; }
        .user-pill:hover { background:rgba(255,255,255,0.1); border-color:var(--border); }
        .avatar { width:32px; height:32px; border-radius:50%; background:#333; background-size:cover; border:1px solid var(--border); }
        
        /* MENU */
        .dropdown { position:absolute; top:65px; right:15px; background:#1a1a1a; border:1px solid var(--border); border-radius:12px; width:200px; display:none; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.8); animation:popIn 0.2s ease; }
        .dropdown.show { display:flex; }
        .item { padding:14px; cursor:pointer; color:#ccc; display:flex; align-items:center; gap:12px; font-size:0.9rem; transition:0.2s; }
        .item:hover { background:rgba(255,255,255,0.05); color:#fff; padding-left:18px; }
        .item.red { color:#ff4d4d; border-top:1px solid var(--border); }
        @keyframes popIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }

        /* FEED */
        #feedContainer { flex:1; overflow-y:scroll; scroll-snap-type:y mandatory; scroll-behavior:smooth; margin-top:60px; height:100vh; }
        .slide { height:100vh; width:100%; scroll-snap-align:start; display:flex; background:#000; position:relative; }

        /* VIDEO ZONE */
        .video-zone { flex:1; display:flex; align-items:center; justify-content:center; background:#000; position:relative; }
        .video-zone video { max-width:100%; max-height:100%; width:100%; height:100%; object-fit:contain; }
        
        /* UI SIDEBAR (Desktop) */
        .ui-zone { width:380px; background:var(--panel); border-left:1px solid var(--border); display:flex; flex-direction:column; z-index:10; padding-top:60px; }
        
        @media(max-width:900px) {
            .ui-zone { position:absolute; bottom:0; left:0; width:100%; height:auto; background:linear-gradient(to top, #000 0%, rgba(0,0,0,0.9) 60%, transparent 100%); border:none; justify-content:flex-end; padding-top:100px; pointer-events:none; }
            .ui-zone > * { pointer-events:auto; }
            .video-zone video { object-fit:cover; }
            .info { text-shadow:0 2px 4px #000; }
            .chat-list { max-height:200px; mask-image:linear-gradient(to bottom, transparent, black 20%); }
        }

        /* INFO & VOTES */
        .info { padding:20px; }
        .tag { background:var(--accent); color:#000; padding:4px 8px; border-radius:6px; font-weight:800; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; display:inline-block; margin-bottom:8px; }
        .title { font-weight:700; font-size:1.1rem; line-height:1.3; }

        .votes { display:flex; gap:10px; padding:0 20px 20px; }
        .v-btn { flex:1; padding:12px; background:rgba(255,255,255,0.05); border-radius:10px; border:1px solid var(--border); color:#bbb; font-weight:700; cursor:pointer; text-align:center; transition:0.2s; position:relative; overflow:hidden; font-size:0.9rem; }
        .v-btn:hover { background:rgba(255,255,255,0.1); color:#fff; }
        .v-btn span.c { font-size:0.8rem; font-weight:400; opacity:0.6; margin-left:5px; }
        .v-btn.valid.active { background:#2ecc71; border-color:#2ecc71; color:#000; box-shadow:0 0 15px rgba(46,204,113,0.3); }
        .v-btn.inting.active { background:#e74c3c; border-color:#e74c3c; color:#000; box-shadow:0 0 15px rgba(231,76,60,0.3); }

        /* CHAT */
        .chat-list { flex:1; overflow-y:auto; padding:15px 20px; display:flex; flex-direction:column; gap:10px; scrollbar-width:thin; scrollbar-color: #333 transparent; }
        .msg { font-size:0.9rem; line-height:1.4; animation:fadeIn 0.2s ease; }
        .msg b { color:var(--accent); margin-right:6px; font-weight:600; font-size:0.85rem; }
        .msg.sys { color:#666; font-style:italic; font-size:0.8rem; text-align:center; margin:10px 0; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

        /* INPUT */
        .input-box { padding:20px; display:flex; gap:10px; background:var(--panel); border-top:1px solid var(--border); }
        input { flex:1; background:#000; border:1px solid var(--border); padding:14px; border-radius:12px; color:#fff; outline:none; transition:0.3s; }
        input:focus { border-color:var(--accent); }
        .send { width:48px; height:48px; border-radius:50%; background:var(--accent); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#000; transition:0.2s; font-size:1rem; }
        .send:hover { transform:scale(1.1); box-shadow:0 0 15px rgba(212,175,55,0.4); }
        @media(max-width:900px) { .input-box { background:transparent; border:none; } input { background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); } }

        /* FAB */
        .fab { position:fixed; bottom:30px; right:30px; width:55px; height:55px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1.5rem; color:#000; box-shadow:0 5px 20px rgba(212,175,55,0.4); z-index:200; transition:0.3s; }
        .fab:hover { transform:scale(1.1) rotate(90deg); }

        /* MODAL */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:300; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal.show { display:flex; }
        .modal-box { background:#1a1a1a; padding:30px; border-radius:20px; width:90%; max-width:400px; display:flex; flex-direction:column; gap:15px; border:1px solid var(--border); animation:popIn 0.3s ease; }
        .modal h3 { font-family:'Oswald'; font-size:1.5rem; color:#fff; margin:0 0 10px; }
        select, input.modal-in { width:100%; padding:14px; background:#000; border:1px solid var(--border); color:#fff; border-radius:10px; outline:none; }
        .btn-pub { width:100%; padding:14px; background:var(--accent); border:none; border-radius:10px; font-weight:bold; cursor:pointer; text-transform:uppercase; letter-spacing:1px; }
    </style>
</head>
<body>

    <header>
        <a href="#" class="logo">DEBATE<span>ROOM</span></a>
        <div style="position:relative;">
            <div class="user-pill" onclick="toggleMenu()">
                <div class="avatar" id="headAvatar"></div>
                <span id="headName" style="margin-left:10px; font-weight:500; font-size:0.9rem;">...</span>
                <i class="fa-solid fa-chevron-down" style="font-size:0.7rem; margin-left:10px; color:#666;"></i>
            </div>
            <div class="dropdown" id="menu">
                <div class="item" onclick="location.href='onboarding.html'"><i class="fa-solid fa-user-pen"></i> Profil</div>
                <div class="item red" onclick="logout()"><i class="fa-solid fa-power-off"></i> D√©connexion</div>
            </div>
        </div>
    </header>

    <div id="feedContainer"></div>

    <div class="fab" onclick="openModal()"><i class="fa-solid fa-plus"></i></div>

    <div class="modal" id="addModal">
        <div class="modal-box">
            <h3>Nouveau D√©bat</h3>
            <select id="newGame">
                <option value="lol">League of Legends</option>
                <option value="valorant">Valorant</option>
                <option value="rl">Rocket League</option>
            </select>
            <input type="text" id="newLink" class="modal-in" placeholder="Lien Outplayed / YouTube">
            <button class="btn-pub" onclick="createRoom()">PUBLIER</button>
            <button onclick="closeModal()" style="background:transparent; border:none; color:#666; cursor:pointer; margin-top:5px;">Annuler</button>
        </div>
    </div>

    <script>
        const rawUser = localStorage.getItem('user_profile');
        if(!rawUser) window.location.href = 'login.html';
        const user = JSON.parse(rawUser);
        document.getElementById('headName').innerText = user.given_name;
        document.getElementById('headAvatar').style.backgroundImage = `url('${user.picture || "https://cdn-icons-png.flaticon.com/512/847/847969.png"}')`;

        const socket = io("https://debateroom-api.onrender.com");
        
        async function loadFeed() {
            try {
                const res = await fetch('https://debateroom-api.onrender.com/api/feed/foryou?email='+user.email);
                const rooms = await res.json();
                const container = document.getElementById('feedContainer');
                container.innerHTML = '';

                if(rooms.length === 0) container.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;color:#666;">Aucun d√©bat. Lancez-en un !</div>';

                rooms.forEach(room => {
                    const v = room.votes?.valid?.length || 0;
                    const i = room.votes?.inting?.length || 0;
                    
                    const slide = document.createElement('div');
                    slide.className = 'slide';
                    slide.dataset.slug = room.slug;
                    slide.innerHTML = `
                        <div class="video-zone"><video src="${room.videoUrl}" loop playsinline></video></div>
                        <div class="ui-zone">
                            <div class="info"><span class="tag">${room.game}</span><div class="title">${room.videoTitle}</div></div>
                            <div class="votes" id="votes-${room.slug}">
                                <div class="v-btn valid" onclick="doVote('${room.slug}','valid')">VALID <span class="c">${v}</span></div>
                                <div class="v-btn inting" onclick="doVote('${room.slug}','inting')">INTING <span class="c">${i}</span></div>
                            </div>
                            <div class="chat-list" id="chat-${room.slug}"><div class="msg sys">D√©but du d√©bat</div></div>
                            <div class="input-box">
                                <input type="text" class="c-in" placeholder="Ton avis ?" onkeypress="checkKey(event,'${room.slug}')">
                                <button class="send" onclick="sendMsg('${room.slug}')"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    `;
                    container.appendChild(slide);
                });
                initObserver();
            } catch(e) { console.error(e); }
        }

        // Remplace ta fonction initObserver par celle-ci :
        function initObserver() {
            const obs = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    const video = e.target.querySelector('video');
                    const roomId = e.target.dataset.slug;

                    if(e.isIntersecting) {
                        console.log("üëÄ Vue sur :", roomId); // DEBUG
                        
                        // 1. On rejoint la salle Socket pour recevoir les messages
                        socket.emit('join_room', roomId);
                        
                        // 2. On lance la vid√©o
                        if(video) video.play();
                    } else {
                        // 3. Si on ne regarde plus, on quitte (optionnel) et on pause
                        // socket.emit('leave_room', roomId); // (√Ä impl√©menter c√¥t√© serveur si besoin)
                        if(video) { 
                            video.pause(); 
                            video.currentTime = 0; 
                        }
                    }
                });
            }, {threshold: 0.5}); // Se d√©clenche quand 50% de la vid√©o est visible

            // On observe toutes les slides
            const slides = document.querySelectorAll('.slide');
            slides.forEach(s => obs.observe(s));
        }

        // Ajoute ceci dans ta fonction 'receive_message' pour debug
        socket.on('receive_message', msg => {
            console.log("üì© Message re√ßu pour la room :", msg.roomId); // DEBUG
            const box = document.getElementById(`chat-${msg.roomId}`);
            
            if(box) {
                const d = document.createElement('div');
                d.className = msg.username==='System' ? 'msg sys' : 'msg';
                d.innerHTML = msg.username==='System' ? msg.text : `<b>${msg.username}:</b> ${msg.text}`;
                box.appendChild(d);
                box.scrollTop = box.scrollHeight;
            } else {
                console.warn("‚ö†Ô∏è Bo√Æte de chat introuvable pour :", msg.roomId);
            }
        });

        socket.on('update_votes', data => {
            const box = document.getElementById(`votes-${data.roomId}`);
            if(box) {
                box.querySelector('.valid .c').innerText = data.valid;
                box.querySelector('.inting .c').innerText = data.inting;
            }
        });

        window.doVote = (rid, choice) => {
            // Anim instantan√©e
            const box = document.getElementById(`votes-${rid}`);
            box.querySelectorAll('.v-btn').forEach(b => b.classList.remove('active'));
            box.querySelector(`.${choice}`).classList.add('active');
            socket.emit('send_vote', { roomId:rid, choice, userId:user.email });
        };
        
        window.sendMsg = (rid) => {
            const input = document.querySelector(`.slide[data-slug="${rid}"] .c-in`);
            if(input.value) {
                socket.emit('send_message', { roomId:rid, username:user.given_name, text:input.value });
                input.value = '';
            }
        };
        window.checkKey = (e, rid) => { if(e.key==='Enter') sendMsg(rid); };

        window.createRoom = async () => {
            const url = document.getElementById('newLink').value;
            const game = document.getElementById('newGame').value;
            if(!url) return alert('Lien requis');
            try {
                const res = await fetch(`https://debateroom-api.onrender.com/api/video/resolve?url=${encodeURIComponent(url)}`);
                const data = await res.json();
                socket.emit('create_room', { src:data.src, title:"D√©bat User", game, platform:"Import" });
                closeModal();
            } catch(e) { alert('Erreur lien'); }
        };

        window.toggleMenu = () => document.getElementById('menu').classList.toggle('show');
        window.logout = () => { localStorage.clear(); window.location.href='login.html'; };
        window.openModal = () => document.getElementById('addModal').classList.add('show');
        window.closeModal = () => document.getElementById('addModal').classList.remove('show');

        // GO
        loadFeed();
    </script>
</body>
</html>