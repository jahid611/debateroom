<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DebateRoom | Setup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg:#050505; --card:#111; --accent:#D4AF37; --text:#FFF; --border:rgba(255,255,255,0.1); }
        body { background:var(--bg); color:var(--text); font-family:'Outfit', sans-serif; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; padding:20px; overflow-x:hidden; }
        
        /* CORRECTION ICI : Hauteur automatique et Scroll */
        .container { 
            width:100%; max-width:850px; 
            background:rgba(18,18,18,0.9); 
            border:1px solid var(--border); 
            border-radius:24px; 
            padding:0; 
            position:relative; 
            display:flex; flex-direction:column; 
            backdrop-filter:blur(20px); 
            box-shadow:0 20px 80px rgba(0,0,0,0.7);
            
            /* C'est ça qui bloquait le bouton : */
            height: auto; 
            min-height: 600px; 
            max-height: 90vh; /* Ne dépasse pas l'écran */
        }
        
        /* Sidebar Progress (Desktop) */
        .sidebar { width: 250px; background: rgba(255,255,255,0.03); border-right: 1px solid var(--border); padding: 40px 30px; display: flex; flex-direction: column; justify-content: center; gap: 40px; }
        .step-indicator { display: flex; align-items: center; gap: 15px; opacity: 0.4; transition: 0.3s; }
        .step-indicator.active { opacity: 1; transform: translateX(10px); }
        .step-num { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #fff; display: flex; align-items: center; justify-content: center; font-family: 'Oswald'; font-size: 0.9rem; }
        .step-indicator.active .step-num { background: var(--accent); border-color: var(--accent); color: #000; box-shadow: 0 0 15px rgba(212,175,55,0.4); }
        .step-title { font-weight: 500; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; }

        /* Main Content - AJOUT DU SCROLL */
        .content { 
            flex: 1; padding: 40px; display: flex; flex-direction: column; position: relative; 
            overflow-y: auto; /* Permet de scroller si trop petit */
        }
        
        /* Pour cacher la barre de scroll moche */
        .content::-webkit-scrollbar { width: 6px; }
        .content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .step-content { display: none; flex-direction: column; height: 100%; animation: fadeRight 0.5s ease; }
        .step-content.active { display: flex; }
        
        @keyframes fadeRight { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }

        h2 { font-family: 'Oswald'; font-size: 2rem; margin: 0 0 10px; }
        h2 span { color: var(--accent); }
        .desc { color: #888; margin-bottom: 20px; font-weight: 300; }

        /* Form Grid */
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .full { grid-column:span 2; }
        input { width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); padding:12px; border-radius:12px; color:#fff; outline:none; transition:0.3s; }
        input:focus { border-color:var(--accent); background:rgba(212,175,55,0.05); }
        input:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Games Cards */
        .games { display:grid; grid-template-columns:repeat(auto-fill, minmax(130px, 1fr)); gap:15px; }
        .game { aspect-ratio:3/4; border:1px solid var(--border); border-radius:16px; cursor:pointer; background-size:cover; background-position:center; transition:0.3s; position:relative; overflow:hidden; }
        .game::after { content:''; position:absolute; inset:0; background:linear-gradient(to top, rgba(0,0,0,0.8), transparent); opacity:0.6; transition:0.3s; }
        .game:hover { transform:translateY(-5px); border-color:#fff; }
        .game.selected { border-color:var(--accent); box-shadow:0 0 25px rgba(212,175,55,0.3); transform:translateY(-5px); }
        .game.selected::after { opacity:0; }
        .check { position:absolute; bottom:10px; right:10px; background:var(--accent); color:#000; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; opacity:0; transform:scale(0); transition:0.3s; z-index:10; }
        .game.selected .check { opacity:1; transform:scale(1); }

        /* Ranks */
        .rank-row { display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:20px; scrollbar-width:none; }
        .rank { min-width:60px; height:60px; border-radius:12px; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; background:rgba(255,255,255,0.02); transition:0.2s; font-size:0.8rem; font-weight:700; color:#666; }
        .rank:hover { background:rgba(255,255,255,0.05); color:#fff; }
        .rank.selected { background:var(--accent); color:#000; border-color:var(--accent); box-shadow:0 5px 15px rgba(212,175,55,0.3); }

        /* Footer Actions */
        .actions { margin-top:30px; display:flex; justify-content:flex-end; gap:15px; border-top:1px solid var(--border); padding-top:20px; }
        button { padding:14px 30px; border-radius:50px; font-weight:700; cursor:pointer; border:none; transition:0.3s; font-family:'Outfit'; text-transform:uppercase; letter-spacing:1px; font-size:0.8rem; }
        .btn-main { background:var(--accent); color:#000; }
        .btn-main:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(212,175,55,0.2); }
        .btn-ghost { background:transparent; color:#666; border:1px solid transparent; }
        .btn-ghost:hover { color:#fff; border-color:#333; }

        @media(max-width:800px) {
            .container { flex-direction:column; height:100vh; max-height:100vh; border-radius:0; border:none; }
            .sidebar { width:100%; flex-direction:row; padding:15px; border-right:none; border-bottom:1px solid var(--border); gap:10px; flex-shrink: 0; }
            .step-title { display:none; }
            .content { padding:20px; }
        }
    </style>
</head>
<body>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <div class="container">
        <div class="sidebar">
            <div class="step-indicator active" id="ind1"><div class="step-num">1</div><div class="step-title">Identité</div></div>
            <div class="step-indicator" id="ind2"><div class="step-num">2</div><div class="step-title">Jeux</div></div>
            <div class="step-indicator" id="ind3"><div class="step-num">3</div><div class="step-title">Niveaux</div></div>
        </div>

        <div class="content">
            <div class="step-content active" id="step1">
                <h2>Qui <span>es-tu ?</span></h2>
                <p class="desc">Ton identité dans l'arène.</p>
                
                <div style="margin-bottom:20px; background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#aaa; font-size:0.9rem;">Auto-remplir avec Google :</span>
                    <div id="g_id_onload" data-client_id="233594795614-4ti76o1u50quom8bedro552dhumdfgfk.apps.googleusercontent.com" data-callback="handleGoogle" data-auto_prompt="false"></div>
                    <div class="g_id_signin" data-type="icon" data-shape="circle" data-theme="filled_black"></div>
                </div>

                <div class="grid">
                    <input type="text" id="prenom" placeholder="Prénom">
                    <input type="text" id="nom" placeholder="Nom">
                    <input type="text" id="pseudo" placeholder="Pseudo (Gamer Tag)" class="full">
                    <input type="number" id="age" placeholder="Âge">
                    <input type="email" id="email" placeholder="Email">
                    <input type="password" id="password" placeholder="Mot de passe" class="full">
                </div>
                
                <div class="actions">
                    <button class="btn-main" onclick="validateStep1()">CONTINUER <i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="step-content" id="step2">
                <h2>Tes <span>Jeux</span></h2>
                <p class="desc">Sélectionne tes terrains de bataille.</p>
                <div class="games">
                    <div class="game" onclick="toggleGame(this,'lol')" style="background-image:url('https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Aatrox_0.jpg')"><div class="check"><i class="fa-solid fa-check"></i></div></div>
                    <div class="game" onclick="toggleGame(this,'valorant')" style="background-image:url('https://images.contentstack.io/v3/assets/bltb6530b271fddd0b1/blt3f072eb373d32571/623267d325e79e623101c59c/Jett_0.jpg')"><div class="check"><i class="fa-solid fa-check"></i></div></div>
                    <div class="game" onclick="toggleGame(this,'rl')" style="background-image:url('https://rocketleague.media.zestyio.com/rl_cross-play_asset_rl_1920.309bf22bd29c2e411e9dd8eb07575bb1.jpg')"><div class="check"><i class="fa-solid fa-check"></i></div></div>
                </div>
                <div class="actions"><button class="btn-ghost" onclick="goStep(1)">Retour</button><button class="btn-main" onclick="validateStep2()">Continuer</button></div>
            </div>

            <div class="step-content" id="step3">
                <h2>Ton <span>Niveau</span></h2>
                <p class="desc">Sois honnête (ou pas).</p>
                <div id="detailsArea" style="flex:1; overflow-y:auto; padding-right:5px;"></div>
                <div class="actions"><button class="btn-ghost" onclick="goStep(2)">Retour</button><button class="btn-main" onclick="finish()">ENTRER DANS L'ARÈNE</button></div>
            </div>
        </div>
    </div>

    <script>
        let googleUser = null, selectedGames = [];
        const preLoad = localStorage.getItem('temp_google_user');
        
        // Si on vient de Login.html avec des infos Google, on pré-remplit
        if(preLoad) {
            const p = JSON.parse(preLoad);
            googleUser = p;
            fillForm(p.given_name, p.family_name, p.email);
            // On nettoie pour ne pas le refaire si on reload
            localStorage.removeItem('temp_google_user');
        }

        function handleGoogle(res) {
            const p = JSON.parse(atob(res.credential.split('.')[1]));
            googleUser = p;
            fillForm(p.given_name, p.family_name, p.email);
            alert("Compte Google détecté ! Remplissez votre Pseudo.");
        }

        function fillForm(first, last, mail) {
            if(first) document.getElementById('prenom').value = first;
            if(last) document.getElementById('nom').value = last;
            if(mail) document.getElementById('email').value = mail;
            document.getElementById('password').disabled = true;
            document.getElementById('password').placeholder = "Compte Google lié ✅";
            document.getElementById('password').style.border = "1px solid #2ecc71";
        }

        function goStep(n) {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step-indicator').forEach(s => s.classList.remove('active'));
            document.getElementById('step'+n).classList.add('active');
            document.getElementById('ind'+n).classList.add('active');
        }

        function validateStep1() {
            const mail = document.getElementById('email').value;
            const pseudo = document.getElementById('pseudo').value;
            
            if(!mail) return alert("L'email est obligatoire.");
            if(!pseudo) return alert("Choisissez un pseudo !");
            
            goStep(2);
        }

        function toggleGame(el, id) {
            el.classList.toggle('selected');
            selectedGames.includes(id) ? selectedGames=selectedGames.filter(x=>x!==id) : selectedGames.push(id);
        }

        function validateStep2() {
            if(selectedGames.length === 0) return alert("Choisis au moins un jeu");
            const container = document.getElementById('detailsArea');
            container.innerHTML = '';
            const gameInfo = {
                'lol': { name: 'LoL', ranks: ['Iron','Bronze','Silver','Gold','Plat','Emerald','Dia','Master'] },
                'valorant': { name: 'Valorant', ranks: ['Iron','Bronze','Silver','Gold','Plat','Dia','Asc','Immo'] },
                'rl': { name: 'Rocket League', ranks: ['Bronze','Silver','Gold','Plat','Dia','Champ','GC','SSL'] }
            };
            selectedGames.forEach(gid => {
                let html = `<div style="margin-bottom:25px;" data-game="${gid}"><h4 style="margin-bottom:10px; color:#fff;">${gameInfo[gid].name}</h4><div class="rank-row">`;
                gameInfo[gid].ranks.forEach(r => html += `<div class="rank" onclick="selectRank(this)">${r}</div>`);
                html += `</div></div>`;
                container.innerHTML += html;
            });
            goStep(3);
        }

        function selectRank(el) {
            Array.from(el.parentElement.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        async function finish() {
            const data = {
                prenom: document.getElementById('prenom').value,
                nom: document.getElementById('nom').value,
                pseudo: document.getElementById('pseudo').value,
                email: document.getElementById('email').value,
                age: document.getElementById('age').value,
                password: document.getElementById('password').value,
                games: selectedGames, details: {}
            };
            
            if(googleUser) { 
                data.googleId=googleUser.sub; 
                data.avatar=googleUser.picture; 
                data.password=null; 
            }

            selectedGames.forEach(gid => {
                const r = document.querySelector(`div[data-game="${gid}"] .rank.selected`);
                data.details[gid] = { rank: r ? r.innerText : 'Unranked' };
            });

            try {
                const res = await fetch('http://localhost:3001/api/auth/onboarding', {
                    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)
                });
                const json = await res.json();
                if(res.ok) {
                    localStorage.setItem('user_profile', JSON.stringify({
                        email: json.user.email, 
                        name: json.user.name, 
                        given_name: json.user.pseudo, 
                        picture: json.user.avatar
                    }));
                    window.location.href = 'index.html';
                } else alert("Erreur: "+json.error);
            } catch(e) { console.error(e); alert("Erreur serveur"); }
        }
    </script>
</body>
</html>