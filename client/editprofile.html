<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DebateRoom | Profil</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg:#050505; --card:#121212; --accent:#D4AF37; --text:#fff; --border:rgba(255,255,255,0.1); }
        * { box-sizing:border-box; margin:0; padding:0; font-family:'Outfit', sans-serif; }
        body { background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:40px 20px; }
        .header-back { position:fixed; top:20px; left:20px; color:#fff; text-decoration:none; font-size:1.2rem; display:flex; align-items:center; gap:10px; z-index:100; transition:0.3s; }
        .header-back:hover { color:var(--accent); }
        .profile-container { width:100%; max-width:700px; background:var(--card); border:1px solid var(--border); border-radius:24px; padding:40px; box-shadow:0 20px 50px rgba(0,0,0,0.5); }
        h1 { font-family:'Oswald'; font-size:2rem; margin-bottom:30px; text-align:center; border-bottom:1px solid var(--border); padding-bottom:20px; }
        h1 span { color:var(--accent); }
        h2 { font-size:1.2rem; margin:30px 0 15px; color:var(--accent); font-weight:600; text-transform:uppercase; letter-spacing:1px; }
        .avatar-section { display:flex; justify-content:center; margin-bottom:30px; }
        .avatar-wrapper { width:120px; height:120px; border-radius:50%; overflow:hidden; border:2px solid var(--border); position:relative; cursor:pointer; transition:0.3s; }
        .avatar-wrapper img { width:100%; height:100%; object-fit:cover; }
        .avatar-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; opacity:0; transition:0.3s; }
        .avatar-wrapper:hover .avatar-overlay { opacity:1; }
        .avatar-wrapper:hover { border-color:var(--accent); }
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .form-group { margin-bottom:15px; }
        label { display:block; margin-bottom:8px; color:#888; font-size:0.9rem; }
        input, textarea, select { width:100%; background:#000; border:1px solid var(--border); padding:15px; border-radius:10px; color:#fff; outline:none; transition:0.3s; font-size:1rem; }
        textarea { resize:vertical; min-height:100px; }
        input:focus, textarea:focus, select:focus { border-color:var(--accent); }
        .game-row { display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid transparent; transition:0.2s; }
        .game-row.active { border-color:var(--accent); background:rgba(212,175,55,0.05); }
        .game-check { display:flex; align-items:center; gap:15px; cursor:pointer; }
        .custom-checkbox { width:24px; height:24px; border:2px solid #666; border-radius:6px; display:flex; align-items:center; justify-content:center; transition:0.2s; }
        .game-row.active .custom-checkbox { background:var(--accent); border-color:var(--accent); color:#000; }
        .game-name { font-weight:600; }
        .rank-select { width:150px; padding:8px; font-size:0.9rem; display:none; }
        .game-row.active .rank-select { display:block; }
        .btn-save { width:100%; padding:15px; background:var(--accent); border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size:1rem; margin-top:30px; transition:0.3s; text-transform:uppercase; letter-spacing:1px; }
        .btn-save:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(212,175,55,0.2); }
        .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#2ecc71; color:#000; padding:12px 25px; border-radius:30px; display:none; font-weight:bold; z-index:200; }
    </style>
</head>
<body>
    <a href="index.html" class="header-back"><i class="fa-solid fa-arrow-left"></i> Retour</a>
    <div class="profile-container">
        <h1>Mon <span>Profil</span></h1>
        <div class="avatar-section">
            <div class="avatar-wrapper" onclick="document.getElementById('fileInput').click()">
                <img id="previewAvatar" src="" alt="Avatar">
                <div class="avatar-overlay"><i class="fa-solid fa-camera" style="font-size:1.5rem; color:#fff;"></i></div>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="uploadAvatar()">
        </div>
        <h2>Identit√©</h2>
        <div class="grid-2">
            <div class="form-group">
                <label>Pr√©nom</label>
                <input type="text" id="prenom">
            </div>
            <div class="form-group">
                <label>Nom</label>
                <input type="text" id="nom">
            </div>
        </div>
        <div class="form-group">
            <label>Pseudo (Affich√©)</label>
            <input type="text" id="pseudo">
        </div>
        <div class="form-group">
            <label>Bio</label>
            <textarea id="bio" placeholder="Parle-nous de toi..."></textarea>
        </div>
        <h2>Mes Jeux & Rangs</h2>
        <div id="gamesContainer"></div>
        <h2 style="color:#e74c3c; margin-top:40px;">S√©curit√©</h2>
        <div class="form-group">
            <label>Nouveau mot de passe (Laisser vide si inchang√©)</label>
            <input type="password" id="newPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="form-group">
            <label>Mot de passe actuel (Requis pour changer)</label>
            <input type="password" id="oldPass">
        </div>
        <button class="btn-save" onclick="saveProfile()">SAUVEGARDER</button>
    </div>
    <div class="toast" id="toast">Profil mis √† jour !</div>
    <script>
        // 1. AUTH & DONN√âES
        const rawUser = localStorage.getItem('user_profile');
        if(!rawUser) window.location.href = 'login.html';
        let user = JSON.parse(rawUser);

        const gameData = {
            'lol': { name: 'League of Legends', ranks: ['Iron','Bronze','Silver','Gold','Platinum','Emerald','Diamond','Master','Grandmaster','Challenger'] },
            'valorant': { name: 'Valorant', ranks: ['Iron','Bronze','Silver','Gold','Platinum','Diamond','Ascendant','Immortal','Radiant'] },
            'rl': { name: 'Rocket League', ranks: ['Bronze','Silver','Gold','Platinum','Diamond','Champion','Grand Champion','SSL'] },
            'fortnite': { name: 'Fortnite', ranks: ['Bronze','Silver','Gold','Platinum','Diamond','Elite','Champion','Unreal'] }
        };

        // 2. PR√â-REMPLISSAGE
        function init() {
            console.log("---- DONN√âES UTILISATEUR CHARG√âES ----");
            console.log(user);

            document.getElementById('previewAvatar').src = user.picture || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            
            const fullName = user.name || "";
            const parts = fullName.split(' ');
            document.getElementById('prenom').value = parts[0] || "";
            document.getElementById('nom').value = parts.slice(1).join(' ') || "";
            document.getElementById('pseudo').value = user.given_name || ""; // given_name = pseudo
            document.getElementById('bio').value = user.bio || "";

            renderGamesUI(user.games || [], user.details || {});
        }

        function renderGamesUI(userGames, userDetails) {
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '';
            for (const [key, data] of Object.entries(gameData)) {
                const isActive = userGames.includes(key);
                const userRank = (userDetails[key] && userDetails[key].rank) ? userDetails[key].rank : "Unranked";
                
                const row = document.createElement('div');
                row.className = `game-row ${isActive ? 'active' : ''}`;
                row.id = `game-${key}`;
                row.onclick = (e) => { if(e.target.tagName !== 'SELECT') toggleGame(key); };

                let options = `<option value="Unranked" ${userRank === 'Unranked' ? 'selected' : ''}>Unranked</option>`;
                data.ranks.forEach(r => {
                    options += `<option value="${r}" ${userRank === r ? 'selected' : ''}>${r}</option>`;
                });

                row.innerHTML = `
                    <div class="game-check">
                        <div class="custom-checkbox"><i class="fa-solid fa-check" style="${isActive ? 'display:block' : 'display:none'}; font-size:0.8rem;"></i></div>
                        <span class="game-name">${data.name}</span>
                    </div>
                    <select class="rank-select" id="rank-${key}" onclick="event.stopPropagation()">${options}</select>
                `;
                container.appendChild(row);
            }
        }

        function toggleGame(key) {
            const row = document.getElementById(`game-${key}`);
            row.classList.toggle('active');
            const icon = row.querySelector('.fa-check');
            icon.style.display = row.classList.contains('active') ? 'block' : 'none';
        }

        // 3. UPLOAD AVATAR
        let newAvatarUrl = null;
        async function uploadAvatar() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return;
            console.log("üì∏ D√©but upload Avatar...", file.name);
            
            const fd = new FormData();
            fd.append('videoFile', file);

            try {
                document.querySelector('.avatar-wrapper').style.opacity = '0.5';
                const res = await fetch('https://debateroom-u1gz.onrender.com/api/video/upload', {
                    method: 'POST', body: fd
                });
                const data = await res.json();
                if(data.src) {
                    newAvatarUrl = data.src;
                    document.getElementById('previewAvatar').src = newAvatarUrl;
                    console.log("‚úÖ Avatar upload√© avec succ√®s sur Cloudinary ! URL :", newAvatarUrl);
                } else {
                    console.error("‚ùå Erreur upload Cloudinary :", data.error);
                    alert("Erreur lors de l'upload de l'image.");
                }
            } catch(e) { 
                console.error("‚ùå Exception upload :", e);
                alert("Erreur de connexion pour l'upload.");
            }
            finally { document.querySelector('.avatar-wrapper').style.opacity = '1'; }
        }

        // 4. SAUVEGARDE GLOBALE
        async function saveProfile() {
            const btn = document.querySelector('.btn-save');
            btn.innerText = "Sauvegarde..."; btn.disabled = true;
            console.log("üíæ D√©but sauvegarde du profil...");

            const activeGames = [];
            const details = {};
            document.querySelectorAll('.game-row.active').forEach(row => {
                const key = row.id.replace('game-', '');
                activeGames.push(key);
                details[key] = { rank: document.getElementById(`rank-${key}`).value };
            });

            const payload = {
                email: user.email,
                prenom: document.getElementById('prenom').value,
                nom: document.getElementById('nom').value,
                pseudo: document.getElementById('pseudo').value,
                bio: document.getElementById('bio').value,
                currentPassword: document.getElementById('oldPass').value,
                newPassword: document.getElementById('newPass').value,
                games: activeGames,
                details: details
            };

            if(newAvatarUrl) {
                payload.avatar = newAvatarUrl;
                console.log("üëâ URL du nouvel avatar incluse dans le payload :", newAvatarUrl);
            } else {
                console.log("üëâ Aucun nouvel avatar √† sauvegarder.");
            }

            try {
                const res = await fetch('https://debateroom-u1gz.onrender.com/api/auth/update', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if(res.ok) {
                    console.log("‚úÖ Sauvegarde r√©ussie ! Mise √† jour du LocalStorage.");
                    user.name = data.user.name;
                    user.given_name = data.user.pseudo;
                    user.picture = data.user.avatar;
                    user.bio = data.user.bio;
                    user.games = data.user.games;
                    user.details = data.user.details;
                    localStorage.setItem('user_profile', JSON.stringify(user));

                    const t = document.getElementById('toast');
                    t.style.display = 'block';
                    setTimeout(() => t.style.display='none', 2000);
                } else {
                    console.error("‚ùå Erreur API Update :", data.error);
                    alert("Erreur: " + data.error);
                }
            } catch(e) { 
                console.error("‚ùå Exception Sauvegarde :", e);
                alert("Erreur serveur"); 
            }
            
            btn.innerText = "SAUVEGARDER"; btn.disabled = false;
        }

        init();
    </script>
</body>
</html>